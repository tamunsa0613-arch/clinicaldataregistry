# Clinical Data Registry - 臨床データ管理システム

Firebase版の臨床データ管理Webアプリケーションです。神経疾患の臨床研究において、患者データ・検査値・治療経過・臨床イベントを統合管理し、経時的な分析・可視化を行います。

## 主な機能

### 患者管理
| 機能 | 説明 |
|------|------|
| **匿名ID自動生成** | `P-001`, `P-002` 形式で自動採番（氏名フィールドなし） |
| **基本情報** | 病名、発症日、入院日、メモを記録 |
| **Excel一括インポート** | 複数患者データをExcelファイルから一括登録 |

### 検査データ
| 機能 | 説明 |
|------|------|
| **OCR読取** | Tesseract.jsによる検査結果画像の自動読取 |
| **手動入力** | 検査項目・数値・単位の直接入力 |
| **個人情報除外** | 氏名・ID・住所等を正規表現で自動フィルタリング |
| **経時データ分析** | 複数日の検査値を折れ線グラフで可視化 |

### 治療薬管理
| 機能 | 説明 |
|------|------|
| **カテゴリ分類** | 抗てんかん薬、ステロイド、免疫グロブリン、血漿交換、免疫抑制剤など |
| **用量記録** | 投与量・単位・開始日・終了日を記録 |
| **タイムライン表示** | 用量を棒グラフの高さで視覚的に表現 |
| **カラーコーディング** | カテゴリごとに色分けして識別 |

### 臨床経過
| 機能 | 説明 |
|------|------|
| **臨床イベント記録** | 発熱、痙攣、意識障害、画像所見などを日付付きで記録 |
| **統合タイムライン** | 治療薬と臨床イベントを同一タイムライン上に表示 |
| **インライン編集** | 一覧画面から直接編集・削除 |

### 経過グラフ作成・エクスポート
| 機能 | 説明 |
|------|------|
| **オーバーレイ表示** | 検査値グラフに治療薬・臨床イベントを重ね合わせ |
| **分離表示** | タイムラインをグラフの上または下に配置 |
| **二軸表示** | 異なるスケールの検査値を左右の軸で表示 |
| **PNG出力** | グラフ画像をダウンロード |
| **Excel出力** | データ編集用にエクスポート |

### 統計解析・可視化 v1.8.0
| 機能 | 説明 |
|------|------|
| **群間比較** | t検定/Mann-Whitney U検定（自動選択）、Box Plot/Violin Plot |
| **ROC曲線解析** | AUC算出、95%CI、最適カットオフ値（Youden Index） |
| **相関解析** | Pearson/Spearman相関、ヒートマップ表示 |
| **スパゲッティプロット** | 個別患者の検査値推移を重ね描き表示 |
| **検査値ヒートマップ** | 患者×検査項目の値を色で可視化 |
| **Kaplan-Meier曲線** | 2群間の生存時間解析、Log-rank検定 |
| **学術誌スタイル** | Nature/NEJM/Lancet等のカラーパレット対応 |

### マルチテナント（組織分離）v1.4.0
| 機能 | 説明 |
|------|------|
| **組織ごとのデータ分離** | 組織単位でデータを完全に分離 |
| **組織セレクター** | 複数組織所属時にヘッダーで切り替え |
| **システム管理パネル** | 組織作成・メンバー一括追加 |
| **役割管理** | オーナー・管理者・メンバーの3段階 |
| **メール一括登録** | コピー＆ペーストで複数メンバーを追加 |

### 多施設共同研究 v2.0.0
| 機能 | 説明 |
|------|------|
| **研究プロジェクト作成** | 研究ナンバー・タイトルで研究を定義 |
| **メンバー招待・権限管理** | PI（全権限）、編集者（全権限）、閲覧のみの3段階 |
| **全施設症例一括閲覧** | 研究モードで全施設の登録症例を一覧表示 |
| **研究ナンバーフィルタリング** | ドロップダウンで研究を切り替え、該当症例のみ表示 |
| **施設名自動付与** | 症例登録時に登録者の施設名を自動記録 |
| **個人データとの完全分離** | 研究データと個人患者データは独立して管理 |

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                  React + Vite (SPA)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │ 患者管理    │ │ 検査データ  │ │ 臨床経過タイムライン │   │
│  │ CRUD       │ │ OCR/入力    │ │ Chart.js可視化      │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                Firebase Authentication                       │
│              (メール/パスワード認証)                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Firestore Database                         │
│                                                              │
│  [v1.4+ マルチテナント構造]                                    │
│  organizations/{orgId}/                                      │
│    └── patients/{patientId}/                                 │
│          ├── labResults/{labId}/                             │
│          ├── treatments/{treatmentId}/                       │
│          └── clinicalEvents/{eventId}/                       │
│                                                              │
│  organizationMembers/{memberId}/                             │
│    └── orgId, uid, email, role                               │
│                                                              │
│  [v2.0 多施設共同研究]                                          │
│  studies/{studyId}/                                          │
│    └── patients/{patientId}/                                 │
│          ├── labResults/{labId}/                             │
│          ├── treatments/{treatmentId}/                       │
│          └── clinicalEvents/{eventId}/                       │
│                                                              │
│  studyMembers/{uid}_{studyId}/                               │
│    └── studyId, uid, email, role, siteName                   │
│                                                              │
│  [レガシー構造（後方互換性）]                                   │
│  users/{uid}/patients/{patientId}/...                        │
│                                                              │
│  config/systemAdmin                                          │
│    └── emails: ["admin@example.com"]                         │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Security Rules                            │
│           request.auth.uid == userId のみ許可                │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  Firebase Hosting                            │
│          https://clinical-data-registry0123.web.app          │
└─────────────────────────────────────────────────────────────┘
```

## 主要な設計判断

### 1. 個人情報保護優先設計
- **氏名フィールド非設置**: 患者の実名を保存するフィールドを意図的に設けない
- **匿名ID自動生成**: 連番で管理し、実名との紐付けは別途管理（紙ベース等）
- **OCR時の個人情報除外**: 正規表現で氏名・住所・電話番号等を自動フィルタリング

### 2. ユーザーデータ完全分離
- Firestoreの `users/{uid}/` 構造により、ユーザーごとにデータを完全分離
- セキュリティルールで `request.auth.uid == userId` を強制
- 他ユーザーのデータへのアクセスは技術的に不可能

### 3. 単一ファイルアーキテクチャ（App.jsx）
- **理由**: 臨床医が理解・修正しやすいシンプルな構造
- **トレードオフ**: ファイルサイズは大きいが、機能の全体像を把握しやすい
- **将来**: 機能追加に伴いコンポーネント分割を検討

### 4. 治療薬カテゴリの事前定義
- 神経疾患治療に特化したカテゴリ（抗てんかん薬、ステロイド、IVIG等）
- 各カテゴリに代表的な薬剤をプリセット
- 「その他」で自由入力も可能

### 5. 可視化とエクスポートの多様性
- **PNG**: 報告書・プレゼン用の画像出力
- **CSV**: Excel/PowerPointでの再編集用
- **SVG**: Illustrator等でのベクター編集用
- 学会発表・論文作成の多様なニーズに対応

### 6. オフライン非対応（意図的）
- 医療データの同期競合リスクを回避
- 常にFirestoreの最新データを参照
- ネットワーク接続必須の運用を前提

## セットアップ手順

### 1. Firebaseプロジェクト作成

1. [Firebase Console](https://console.firebase.google.com) にアクセス
2. 「プロジェクトを追加」をクリック
3. プロジェクト名を入力（例: `clinical-data-registry`）
4. Google Analyticsは任意（不要ならオフ）

### 2. Authentication設定

1. 左メニュー「Authentication」→「始める」
2. 「Sign-in method」タブで「メール/パスワード」を有効化

### 3. Firestore Database作成

1. 左メニュー「Firestore Database」→「データベースを作成」
2. **「本番モード」** を選択
3. ロケーション: `asia-northeast1`（東京）を推奨
4. 「ルール」タブで `firestore.rules` の内容を貼り付けて公開

### 4. アプリ設定

1. プロジェクト設定（歯車アイコン）→「マイアプリ」
2. 「</>」（ウェブ）をクリックしてアプリ登録
3. 表示される `firebaseConfig` を `src/firebase.js` に反映

```javascript
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef"
};
```

### 5. ローカル起動

```bash
# 依存関係インストール
npm install

# 開発サーバー起動
npm run dev

# ブラウザで http://localhost:3000 を開く
```

### 6. デプロイ

```bash
# Firebase CLIがない場合
npm install -g firebase-tools

# ログイン
firebase login

# ビルド＆デプロイ
npm run build
firebase deploy --only hosting
```

### 7. システム管理者の設定（v1.4.0以降）

マルチテナント機能を使用する場合、システム管理者を設定します。

1. [Firebase Console](https://console.firebase.google.com) > Firestore Database
2. `config` コレクションを選択（なければ作成）
3. ドキュメントID `systemAdmin` で新規ドキュメントを作成
4. フィールドを追加:
   - **フィールド名**: `emails`
   - **型**: `array`
   - **値**: システム管理者のメールアドレス

```
config/systemAdmin
  └── emails: ["admin@example.com", "admin2@example.com"]
```

設定後、アプリをリロードすると「🔧 システム管理」ボタンが表示されます。

### 8. 組織の作成と管理

1. システム管理パネルで「新規組織作成」
2. 組織名、プラン（無料/有料）、オーナーのメールを入力
3. 「メンバー一括追加」でメールアドレスをペースト
4. メンバーがログインすると自動的に組織に紐付け

## ディレクトリ構成

```
clinical-data-firebase/
├── index.html           # エントリーHTML
├── package.json         # 依存関係定義
├── vite.config.js       # Viteビルド設定
├── firebase.json        # Firebase設定
├── firestore.rules      # Firestoreセキュリティルール
├── .firebaserc          # Firebaseプロジェクト紐付け
├── src/
│   ├── main.jsx         # Reactエントリーポイント
│   ├── App.jsx          # メインアプリケーション（全機能）
│   └── firebase.js      # Firebase初期化設定
├── functions/           # Cloud Functions（将来拡張用）
└── dist/                # ビルド出力
```

## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フロントエンド | React 19, Vite 5 |
| バックエンド | Firebase (Auth, Firestore, Hosting, Cloud Functions) |
| グラフ描画 | Chart.js, react-chartjs-2, SVG (カスタム) |
| OCR | Tesseract.js, Cloud Vision API |
| Excel処理 | SheetJS (xlsx) |
| 統計解析 | ブラウザ内実装（t検定、Mann-Whitney、Log-rank等） |

## 倫理審査対応のポイント

研究利用の場合、以下を考慮:

1. **データの匿名化**: 患者氏名を保存しない設計
2. **アクセス制御**: ユーザーごとのデータ分離、Firebase認証必須
3. **監査ログ**: Firebaseの監査ログ機能を有効化可能
4. **データ保存場所**: Firestoreのロケーションを国内（asia-northeast1）に設定
5. **同意取得**: 患者同意に基づくデータ登録フローの追加を推奨

## 将来の拡張案

- [x] Cloud Vision APIによる高精度OCR（v1.1.0で実装済み）
- [x] 複数ユーザー間でのデータ共有（v1.4.0 マルチテナント機能で実装済み）
- [x] 統計解析機能・生存分析（v1.8.0で実装済み：群間比較、ROC、相関、KM曲線）
- [x] 多施設共同研究（v2.0.0で実装済み：研究プロジェクト、権限管理、全施設一括閲覧）
- [ ] PDFレポート自動生成
- [ ] ANOVA（3群以上の比較）
- [ ] モバイル対応（PWA）

## ライセンス

MIT License

## 作者

臨床医による臨床医のための研究支援ツール
