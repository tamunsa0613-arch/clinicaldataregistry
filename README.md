# Clinical Data Registry - 臨床データ管理システム

Firebase版の臨床データ管理Webアプリケーションです。神経疾患の臨床研究において、患者データ・検査値・治療経過・臨床イベントを統合管理し、経時的な分析・可視化を行います。

## 主な機能

### 患者管理
| 機能 | 説明 |
|------|------|
| **匿名ID自動生成** | `P-001`, `P-002` 形式で自動採番（氏名フィールドなし） |
| **基本情報** | 病名、発症日、入院日、メモを記録 |
| **Excel一括インポート** | 複数患者データをExcelファイルから一括登録 |

### 検査データ
| 機能 | 説明 |
|------|------|
| **OCR読取** | Tesseract.jsによる検査結果画像の自動読取 |
| **手動入力** | 検査項目・数値・単位の直接入力 |
| **個人情報除外** | 氏名・ID・住所等を正規表現で自動フィルタリング |
| **経時データ分析** | 複数日の検査値を折れ線グラフで可視化 |

### 治療薬管理
| 機能 | 説明 |
|------|------|
| **カテゴリ分類** | 抗てんかん薬、ステロイド、免疫グロブリン、血漿交換、免疫抑制剤など |
| **用量記録** | 投与量・単位・開始日・終了日を記録 |
| **タイムライン表示** | 用量を棒グラフの高さで視覚的に表現 |
| **カラーコーディング** | カテゴリごとに色分けして識別 |

### 臨床経過
| 機能 | 説明 |
|------|------|
| **臨床イベント記録** | 発熱、痙攣、意識障害、画像所見などを日付付きで記録 |
| **統合タイムライン** | 治療薬と臨床イベントを同一タイムライン上に表示 |
| **インライン編集** | 一覧画面から直接編集・削除 |

### 経時データ分析・エクスポート
| 機能 | 説明 |
|------|------|
| **オーバーレイ表示** | 検査値グラフに治療薬・臨床イベントを重ね合わせ |
| **分離表示** | タイムラインをグラフの上または下に配置 |
| **PNG出力** | グラフ画像をダウンロード |
| **CSV出力** | PowerPoint等で編集可能なデータ出力 |
| **SVG出力** | ベクター形式でエクスポート（編集可能） |

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                  React + Vite (SPA)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │ 患者管理    │ │ 検査データ  │ │ 臨床経過タイムライン │   │
│  │ CRUD       │ │ OCR/入力    │ │ Chart.js可視化      │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                Firebase Authentication                       │
│              (メール/パスワード認証)                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Firestore Database                         │
│  users/{uid}/                                                │
│    └── patients/{patientId}/                                 │
│          ├── displayId, diagnosis, onsetDate, admissionDate  │
│          ├── labResults/{labId}/                             │
│          │     └── date, data[], createdAt                   │
│          ├── treatments/{treatmentId}/                       │
│          │     └── category, medication, dosage, unit,       │
│          │         startDate, endDate, notes                 │
│          └── clinicalEvents/{eventId}/                       │
│                └── date, category, description, severity     │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Security Rules                            │
│           request.auth.uid == userId のみ許可                │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  Firebase Hosting                            │
│          https://clinical-data-registry0123.web.app          │
└─────────────────────────────────────────────────────────────┘
```

## 主要な設計判断

### 1. 個人情報保護優先設計
- **氏名フィールド非設置**: 患者の実名を保存するフィールドを意図的に設けない
- **匿名ID自動生成**: 連番で管理し、実名との紐付けは別途管理（紙ベース等）
- **OCR時の個人情報除外**: 正規表現で氏名・住所・電話番号等を自動フィルタリング

### 2. ユーザーデータ完全分離
- Firestoreの `users/{uid}/` 構造により、ユーザーごとにデータを完全分離
- セキュリティルールで `request.auth.uid == userId` を強制
- 他ユーザーのデータへのアクセスは技術的に不可能

### 3. 単一ファイルアーキテクチャ（App.jsx）
- **理由**: 臨床医が理解・修正しやすいシンプルな構造
- **トレードオフ**: ファイルサイズは大きいが、機能の全体像を把握しやすい
- **将来**: 機能追加に伴いコンポーネント分割を検討

### 4. 治療薬カテゴリの事前定義
- 神経疾患治療に特化したカテゴリ（抗てんかん薬、ステロイド、IVIG等）
- 各カテゴリに代表的な薬剤をプリセット
- 「その他」で自由入力も可能

### 5. 可視化とエクスポートの多様性
- **PNG**: 報告書・プレゼン用の画像出力
- **CSV**: Excel/PowerPointでの再編集用
- **SVG**: Illustrator等でのベクター編集用
- 学会発表・論文作成の多様なニーズに対応

### 6. オフライン非対応（意図的）
- 医療データの同期競合リスクを回避
- 常にFirestoreの最新データを参照
- ネットワーク接続必須の運用を前提

## セットアップ手順

### 1. Firebaseプロジェクト作成

1. [Firebase Console](https://console.firebase.google.com) にアクセス
2. 「プロジェクトを追加」をクリック
3. プロジェクト名を入力（例: `clinical-data-registry`）
4. Google Analyticsは任意（不要ならオフ）

### 2. Authentication設定

1. 左メニュー「Authentication」→「始める」
2. 「Sign-in method」タブで「メール/パスワード」を有効化

### 3. Firestore Database作成

1. 左メニュー「Firestore Database」→「データベースを作成」
2. **「本番モード」** を選択
3. ロケーション: `asia-northeast1`（東京）を推奨
4. 「ルール」タブで `firestore.rules` の内容を貼り付けて公開

### 4. アプリ設定

1. プロジェクト設定（歯車アイコン）→「マイアプリ」
2. 「</>」（ウェブ）をクリックしてアプリ登録
3. 表示される `firebaseConfig` を `src/firebase.js` に反映

```javascript
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef"
};
```

### 5. ローカル起動

```bash
# 依存関係インストール
npm install

# 開発サーバー起動
npm run dev

# ブラウザで http://localhost:3000 を開く
```

### 6. デプロイ

```bash
# Firebase CLIがない場合
npm install -g firebase-tools

# ログイン
firebase login

# ビルド＆デプロイ
npm run build
firebase deploy --only hosting
```

## ディレクトリ構成

```
clinical-data-firebase/
├── index.html           # エントリーHTML
├── package.json         # 依存関係定義
├── vite.config.js       # Viteビルド設定
├── firebase.json        # Firebase設定
├── firestore.rules      # Firestoreセキュリティルール
├── .firebaserc          # Firebaseプロジェクト紐付け
├── src/
│   ├── main.jsx         # Reactエントリーポイント
│   ├── App.jsx          # メインアプリケーション（全機能）
│   └── firebase.js      # Firebase初期化設定
├── functions/           # Cloud Functions（将来拡張用）
└── dist/                # ビルド出力
```

## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フロントエンド | React 18, Vite 5 |
| バックエンド | Firebase (Auth, Firestore, Hosting) |
| グラフ描画 | Chart.js, react-chartjs-2 |
| OCR | Tesseract.js |
| Excel処理 | SheetJS (xlsx) |

## 倫理審査対応のポイント

研究利用の場合、以下を考慮:

1. **データの匿名化**: 患者氏名を保存しない設計
2. **アクセス制御**: ユーザーごとのデータ分離、Firebase認証必須
3. **監査ログ**: Firebaseの監査ログ機能を有効化可能
4. **データ保存場所**: Firestoreのロケーションを国内（asia-northeast1）に設定
5. **同意取得**: 患者同意に基づくデータ登録フローの追加を推奨

## 将来の拡張案

- [ ] Cloud Vision APIによる高精度OCR
- [ ] 複数ユーザー間でのデータ共有（共同研究用）
- [ ] PDFレポート自動生成
- [ ] 統計解析機能（生存分析等）
- [ ] モバイル対応（PWA）

## ライセンス

MIT License

## 作者

臨床医による臨床医のための研究支援ツール
