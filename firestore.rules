// ============================================================
// Firestore Security Rules
// ============================================================
// Firebase Console > Firestore Database > ルール に貼り付け
// ============================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // ヘルパー関数
    // ============================================================

    // システム管理者かどうかをチェック
    function isSystemAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/config/systemAdmin) &&
        request.auth.token.email in get(/databases/$(database)/documents/config/systemAdmin).data.emails;
    }

    // 組織のメンバーかどうかをチェック
    function isMemberOfOrg(orgId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/organizationMembers/$(request.auth.uid + '_' + orgId));
    }

    // 組織での役割を取得
    function getOrgRole(orgId) {
      return get(/databases/$(database)/documents/organizationMembers/$(request.auth.uid + '_' + orgId)).data.role;
    }

    // 組織のオーナーまたは管理者かどうか
    function isOrgAdminOrOwner(orgId) {
      return isMemberOfOrg(orgId) && getOrgRole(orgId) in ['owner', 'admin'];
    }

    // ============================================================
    // 組織関連のルール（新システム）
    // ============================================================

    // 組織
    match /organizations/{orgId} {
      // メンバーまたはシステム管理者のみ読み取り可能
      allow read: if isMemberOfOrg(orgId) || isSystemAdmin();
      // システム管理者のみ作成可能
      allow create: if isSystemAdmin();
      // オーナー/管理者またはシステム管理者のみ更新可能
      allow update: if isSystemAdmin() || isOrgAdminOrOwner(orgId);
      // システム管理者のみ削除可能
      allow delete: if isSystemAdmin();

      // 組織内の患者データ
      match /patients/{patientId} {
        allow read, write: if isMemberOfOrg(orgId);

        match /labResults/{labId} {
          allow read, write: if isMemberOfOrg(orgId);
        }

        match /treatments/{treatmentId} {
          allow read, write: if isMemberOfOrg(orgId);
        }

        match /clinicalEvents/{eventId} {
          allow read, write: if isMemberOfOrg(orgId);
        }
      }
    }

    // 組織メンバーシップ
    match /organizationMembers/{memberId} {
      // 自分のメンバーシップ、または組織管理者、またはシステム管理者は読み取り可能
      allow read: if request.auth != null && (
        resource.data.uid == request.auth.uid ||
        resource.data.email == request.auth.token.email ||
        isSystemAdmin() ||
        isOrgAdminOrOwner(resource.data.orgId)
      );
      // システム管理者または組織管理者のみ作成可能
      allow create: if isSystemAdmin() || (
        request.auth != null &&
        isOrgAdminOrOwner(request.resource.data.orgId)
      );
      // システム管理者または組織管理者のみ更新・削除可能
      allow update, delete: if isSystemAdmin() || (
        request.auth != null &&
        isOrgAdminOrOwner(resource.data.orgId)
      );
    }

    // ============================================================
    // 研究プロジェクト関連のルール（多施設共同研究）
    // ============================================================

    // 研究メンバーかどうかをチェック
    function isStudyMember(studyId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/studyMembers/$(request.auth.uid + '_' + studyId));
    }

    // 研究での役割を取得
    function getStudyRole(studyId) {
      return get(/databases/$(database)/documents/studyMembers/$(request.auth.uid + '_' + studyId)).data.role;
    }

    // 研究のPI または編集者かどうか
    function isStudyEditor(studyId) {
      return isStudyMember(studyId) && getStudyRole(studyId) in ['pi', 'editor'];
    }

    // 研究のPIかどうか
    function isStudyPI(studyId) {
      return isStudyMember(studyId) && getStudyRole(studyId) == 'pi';
    }

    // 研究プロジェクト
    match /studies/{studyId} {
      allow read: if isStudyMember(studyId) || isSystemAdmin();
      allow create: if request.auth != null;
      allow update: if isStudyPI(studyId) || isSystemAdmin();
      allow delete: if isStudyPI(studyId) || isSystemAdmin();

      // 研究内の患者データ
      match /patients/{patientId} {
        allow read: if isStudyMember(studyId);
        allow create, update, delete: if isStudyEditor(studyId);

        match /labResults/{labId} {
          allow read: if isStudyMember(studyId);
          allow create, update, delete: if isStudyEditor(studyId);
        }

        match /treatments/{treatmentId} {
          allow read: if isStudyMember(studyId);
          allow create, update, delete: if isStudyEditor(studyId);
        }

        match /clinicalEvents/{eventId} {
          allow read: if isStudyMember(studyId);
          allow create, update, delete: if isStudyEditor(studyId);
        }
      }
    }

    // 研究メンバーシップ
    match /studyMembers/{memberId} {
      allow read: if request.auth != null && (
        resource.data.uid == request.auth.uid ||
        resource.data.email == request.auth.token.email ||
        isSystemAdmin()
      );
      allow create: if request.auth != null;
      allow update: if isSystemAdmin() || (
        request.auth != null && (
          // PIはメンバーの権限を変更可能
          isStudyPI(resource.data.studyId) ||
          // メールベースのメンバーシップをUIDにリンク
          (resource.data.email == request.auth.token.email &&
           request.resource.data.uid == request.auth.uid)
        )
      );
      allow delete: if isSystemAdmin() || isStudyPI(resource.data.studyId);
    }

    // ============================================================
    // 既存のルール（後方互換性のため維持）
    // ============================================================

    // ユーザーは自分のデータのみアクセス可能
    match /users/{userId} {
      // 認証済みユーザーが自分のドキュメントのみアクセス可能
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // 患者データ（レガシー）
      match /patients/{patientId} {
        // 認証済みユーザーが自分の患者データのみアクセス可能
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // 検査データ
        match /labResults/{labId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // 治療データ
        match /treatments/{treatmentId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // 臨床経過データ
        match /clinicalEvents/{eventId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    // 設定データ（管理者設定、許可リスト設定）
    match /config/{configId} {
      // 認証済みユーザーは読み取り可能
      allow read: if request.auth != null;
      // システム管理者のみ書き込み可能
      allow write: if isSystemAdmin();
    }

    // メールアドレス許可リスト
    match /allowedEmails/{emailId} {
      // 認証済みユーザーは読み取り可能
      allow read: if request.auth != null;
      // システム管理者のみ書き込み可能
      allow write: if isSystemAdmin();
    }
  }
}
